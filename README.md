# NIPT-Analysis: 基于多因素的无创产前检测（NIPT）数据建模与最佳检测时机研究

<p align="center">
  <img src="https://img.shields.io/badge/Python-3.8+-blue.svg" alt="Python Version">
  <img src="https://img.shields.io/badge/License-MIT-green.svg" alt="License">
  <img src="https://img.shields.io/badge/Status-研究中-orange.svg" alt="Status">
</p>

## 项目简介

本项目致力于通过数据科学与统计建模方法，优化无创产前检测(NIPT)的实施策略，尤其是针对检测时机的精确把握。通过多因素综合分析和精细化分组，为不同特征的孕妇群体提供个性化检测方案建议，以提高检测准确性并降低医疗资源浪费。

## 主要功能

- **Y染色体浓度动态模型**：基于线性混合效应模型(LMM)量化Y染色体浓度与孕周、BMI等因素的关系
- **最佳检测时机推荐**：根据孕妇BMI分组，提供男胎Y染色体浓度达到4%阈值的最佳检测时间
- **多因素精细化分组**：整合身高、体重、年龄等因素，采用K-means聚类实现更精准的孕妇分组
- **女胎异常风险评估**：基于多维特征构建异常检测系统，解决女胎样本中没有Y染色体信号的判断难题

## 项目结构

```
NIPT-Analysis/
├── 国赛论文/
├── 题目一/ 
│   ├── 代码/					# 题目一源代码目录
│   └── 原始数据&修改后的数据/
├── 题目二/
│   ├── 代码/					# 题目二源代码目录
│   └── 数据/
├── 题目三/
│   ├── 代码/					# 题目三源代码目录
│   └── 数据/
├── 题目四/
│   ├── 代码/					# 题目四源代码目录
│   └── 数据/
└── 数据处理脚本/				# 数据处理 + 数据可视化
```


## 问题重述

**问题一**：基于附件数据，系统性分析胎儿 Y 染色体浓度与孕妇孕周数、BMI等重要指标之间的关联，建立能够量化这种关系的数学模型，并对模型的统计显著性进行检验与评价。

**问题二**：临床研究表明，对于怀有男胎的孕妇，其BMI值是决定胎儿Y染色体浓度首次达到或超过4%这一阈值所需时间的主要影响因素。根据这些孕妇的BMI数据，科学地将她们划分为若干合理区间，针对每个BMI区间确定一个最优的NIPT检测时机，使得孕妇因延误诊断而面临的潜在风险降至最低，并进一步探讨检测误差对该最佳时机选择结果的影响。

**问题三**：问题三在问题二的基础上进一步细化，把身高、体重、年龄等因素也纳入分析，同时结合检测误差和不同孕妇群体中Y染色体浓度达标比例的实际情况，重新对男胎孕妇进行更科学的分组。为每一组孕妇找到一个最佳的NIPT检测时点，使得Y染色体浓度尽可能早且稳定地达到4%以上，从而最大限度降低因检测时机不当带来的潜在风险。最后，评估检测误差对结果的影响，确保推荐的时点在实际操作中具有可靠性。

**问题四**：与男胎不同的是，女胎没有Y染色体，所以NIPT检测不能通过Y染色体浓度来判断结果是否可靠，也不能直接判断胎儿是否健康。因此，判断女胎是否存在染色体异常是比较复杂的。我们需要针对女胎孕妇，综合利用13、18、21 号染色体的Z值、X染色体的Z值、GC含量、测序读段数及相关比例、孕妇BMI等多维度因素，为女胎设计一套科学、可靠的异常判定方法。

## 问题分析

### 问题一的分析
Y染色体浓度与孕周、BMI等因素的关系需要考虑个体差异。由于存在同一孕妇的多次检测数据，需要采用能够处理重复测量的统计模型。线性混合效应模型(LMM)是合适的选择，它可以同时估计固定效应(群体平均效应)和随机效应(个体差异)。

### 问题二的分析
需要基于问题一的模型结果，确定每位孕妇Y染色体浓度首次达到4%阈值的时间点，并根据BMI分组给出推荐检测时间。还需考虑测量误差对推荐时间的影响，确保推荐时间具有稳健性。

### 问题三的分析
在问题二的基础上，纳入更多因素(身高、体重、年龄等)，探索更精细的分组方法，如K-means聚类等。需评估不同分组方法的效果，并确定最佳的分组策略和对应的检测时间点。

### 问题四的分析
女胎没有Y染色体信号，需要构建基于多维特征的异常检测模型。可考虑统计方法(如Mahalanobis距离)和机器学习方法(如Isolation Forest)的结合，以提高异常检测的准确性和可解释性。

## 符号说明

| 符号 | 说明 |
|:-----|:-----|
| i, j | 数字下标 |
| A(num) | 女胎产妇编号 |
| B(num) | 成品的调换损失 |
| c(y) | Y染色体浓度 |
| c(x) | X染色体浓度 |
| c(BMI) | 孕妇BMI |
| time_past | 检测日期同最后一次月经的时间差 |
| time_test | 检测孕周 |
| gain | 检测抽血次数 |
| pre | 怀孕次数 |
| te_to | 生产次数 |
| diff | 自主评测差值_1 |
| w | 体重 |
| C_total | 总成本 |

## 模型的建立与求解

### 数据预处理

#### 核心数据编码
对于已有附件给出的数据，为便于后续更加系统性的建模分析，优先进行一系列的数据清洗，主要处理了以下几个方面：

- 检测孕周：统一转换为"孕期天数"统一单位，以便与检测日期进行对齐分析、和后续。
- 怀孕孕次：将怀孕次数≥3的样本统一归为3次，以减少极端值影响；
- 受孕方式：自然受孕编码为1，IUI（人工授精）编码为2，IVF（试管婴儿）编码为3。
- 胎儿健康状态：健康编码为1，异常编码为2。
- 将末次月经同每一次检测的日期进行关联，日期差值命名为"检测日期同最后一次月经的时间差"替换掉末次月经特征，随后将检测日期特征移除。

#### 缺失值填补
经上数据清洗后，发现部分样本未记录末次月经（LMP）日期（男胎检测数据中编号为A108、A139、A159），但记录了检测日期及孕周，故根据已有完整信息完全可采用确定性反向推算补全缺失值，具体求解即：

LMP = 检测日期 - 孕期天数

| 孕妇代码 | 检测日期 | 孕期天数 | 末次月经时间 |
|---------|----------|---------|------------|
| A108 | 2023-10-23 | 89 天 | 2023-07-26 |
| A139 | 2023-04-06 | 85 天 | 2023-01-11 |
| A159 | 2023-06-15 | 95 天 | 2023-03-12 |

#### BMI数据校验
BMI由身高与体重计算得出，所有人群通用的计算公式为：

$$
BMI = \frac{w}{(h_m)^2}
$$

即某人的BMI=体重（kg）/[身高（m）]²，其中w为该人的体重，体重单位为千克，h_m为该人的身高，单位为米。

为确保数据准确性，团队建立校验流程用于验证已有孕妇BMI特征的准确性，具体流程如下：

1. 读取原始Excel数据，解析数据特征。
2. 考虑数据单位不一，为方便计算我们将身高和体重进行单位换算。
3. 计算BMI并保留一位小数。
4. BMI验证比较

差值公式：
$$
diff_i = BMI_{rounded} - cBMI_i
$$

其中diff_i为自主评测差值_1，cBMI_i为当前孕妇i的BMI指标。

5. 标记状态为：一致（OK）、不匹配（Mismatch）、缺失（Missing）或异常（Implausible）。

$$
|diff| \leq TOLERANCE \rightarrow ok\\
else \rightarrow Mismatch
$$

此处的TOLERANCE团队设置为足够反应数据是否异常的0.1，对于可能存在的异常BMI值，设置警戒值:
$$
MIN\_BMI = 10\\
MAX\_BMI = 60
$$

当测量值超出最大警戒值或小于最小警戒值，即：
$$
BMI_{rounded} < MIN\_BMI\ (or\ cBMI_i)\\
BMI_{rounded} > MAX\_BMI\ (or\ cBMI_i)
$$

将提供Implausible预警标记。

通过Bland-Altman一致性图可视化，检验计算值与表中值的一致性，判断差值是否随BMI大小存在系统性偏差，并提供统计一致性区间。

#### 异常数据修复
对异常值进行人工复核，必要时剔除或修正。数据中发现A160检测日期同最后一次月经的时间差值为负数（-103），团队注意到这一错误，追溯原附件发现男胎检测数据中编号为A160的孕妇其末次月经时间存在混乱，第一次和第四次同二三次不一，团队通过确定性计算将该异常值修复，统一了其末次月经时间。

### 问题一模型的建立与求解

对于数据处理后的附件数据，已知其为1083行数据，34项特征的表格文件，团队初步采用皮尔逊相关系数进行相关性基本判断尝试，具体步骤如下：

1. 剔除序号、孕妇代码等明显无关特征后形成1083×30拟定数据集，考虑到数据集中既有连续变量又有0/1变量的情况，团队对拟定数据集进行Min-Max Scaling归一化处理统一量纲：

$$
data_{'ij} = \frac{data_{ij} - data_{i\_min}}{data_{i\_max} - data_{i\_min}}
$$

2. 对于个体内特征相关性联合群体分析探讨，通过数据观察可视化，男胎检测数据中267名孕妇成员中有超过240最高至251名孕妇检测抽血次数大于等于三次（gain ≥ 3），足够进行个体内相关研究。

通过个体内特征相关性采用三种关联方法（皮尔逊相关系数、斯皮尔曼秩相关、肯德尔秩相关）进行求解，发现：
- 检测孕周（time_test）越大，Y染色体浓度（cy）越高。
- 孕妇BMI（cBMI）越高，Y染色体浓度（cy）也倾向于越高。

3. 关系模型的最终确认、检验和显著性分析：

经过多次模型优化和参数调整，最终建立了收敛的线性混合效应模型：

$$
Y_{ij} = 0.078413 + 0.000476(gest\_week_{ij} - 117.919593) - 0.001193(bmi_{ij} - 32.288791) + b_{0j} + b_{1j}(gest\_week_{ij} - 117.919593) + \varepsilon_{ij}
$$

其中，随机效应向量：
$$
b_j = (b_{0j}, b_{1j})^T \sim N(0, G)
$$

$$
Cov(b_0, b_1) = 1.898944 \times 10^{-6}
$$

$$
Var(b_1) = 7.415985 \times 10^{-8} (gest\_week随机斜率方差）
$$

残差方差：
$$
\sigma^2 \approx 0.00020793679 ~~~~~~~~~~ \sigma \approx 0.001442
$$

模型的解释力和评价指标：
- Marginal R² = 0.4197（仅固定效应解释，约42%）
- Conditional R² = 0.5215（固定随机一起解释，约52%）
- ICC ≈ 0.8018（约80%的变异来自孕妇之间的系统差异）

这表明Y染色体浓度随孕周显著增加，而与BMI呈负相关关系，且个体差异显著。

### 问题二模型的建立与求解

基于问题一的线性混合效应模型，我们需要确定每位孕妇Y染色体浓度首次达到4%阈值的时间点，并根据BMI分组给出推荐检测时间。

1. 个体预测函数(代入BLUP)
对第j位孕妇，用估计的固定效应与该孕妇的BLUP $(b_{0j}, b_{1j})$ 构建个体预测曲线：

$$
Y_j(t) = \beta_0 + \beta_1(t-\bar{t}) + \beta_2(BMI_j-\overline{BMI}) + b_{0j} + b_{1j}(t-\bar{t})
$$

2. 最早达阈时间 $t^*_j$ 求解
解方程 $Y_j(t^*_j) = 0.04$ （阈值）。若总斜率非零，则：

$$
t^*_j = \bar{t} + \frac{0.04 - \beta_0 - \beta_2(BMI_j-\overline{BMI}) - b_{0j}}{\beta_1 + b_{1j}}
$$

若分母≤0（即该孕妇预测斜率非正）或 $t^*_j$ 不在合理时间范围，则判为"无法达标/需长期随访"。

3. 组级汇总(推荐时点)
对BMI组G，把组内所有可解的 $t^*_j$ 排序并取第p百分位（例如p=0.9）；用该 $t^*_G$ 作为"该组的推荐首NIPT时点"：

$$
t^*_G = quantile_p(\{t^*_j: j \in G\})
$$

4. 模型最终选择patient-level分组策略，得到如下结果：

| Bmi_group | n | Median_tstar | P90_tstar |
|:------:|:-:|:---------:|:------:|
| Q1：c(BMI) ∈ [20.70, 30.32] | 67 | 78.099211 | 78.099211 |
| Q2：c(BMI) ∈ [30.32, 31.74] | 67 | 81.881629 | 82.198172 |
| Q3：c(BMI) ∈ [31.74, 33.86] | 66 | 84.211475 | 84.211475 |
| Q4：c(BMI) ∈ [33.86, 46.88] | 67 | 88.957453 | 92.797798 |

通过Log-rank检验（p=0.0087），证实不同BMI组间达标时间存在显著差异，高BMI组（Q4）需要显著更晚才能有90%的概率达到0.04 Yconc。

5. 测量误差敏感性分析
通过Monte Carlo模拟，评估不同测量误差标准差对推荐时点的影响：
- 测量标准差0.001：t* 典型不确定约为2.1天
- 测量标准差0.002：约4.2天
- 测量标准差0.005：约为10.5天

即使是很小的测量噪声（0.001），也会把判定时点左右摆动几天；若噪声较大，需要将推荐时点向后调整以控制假阴风险。

###  问题三模型的建立与求解

问题三在问题二的基础上，进一步考虑多种因素对Y染色体浓度的影响，扩展模型如下：

$$
Y_{ij} = \beta_0 + \beta_t t_{ij} + \beta_{BMI} BMI_{ij} + \beta_w WT_{ij} + \beta_p parity_j + \beta_a age_{ij} + b_{0j} + b_{1j} t_{ij} + \varepsilon_{ij}
$$

对于分组策略，团队尝试了多种方法：
1. Quantile（四分位分组）
2. 临床分组（Clinical）
3. 自定义分组（Custom）
4. K-means聚类
5. 高斯混合模型（GMM）
6. 决策树（监督）

通过多种方法对比和评估，团队发现K-means聚类能够更好地反映分组后的组间差异。将K值设为5，得到了更精细的分组结果，为每组提供了更准确的推荐检测时间。

测量误差敏感性分析显示，虽然模型对小幅度噪声相对稳健，但一旦噪声幅度过高，推荐时间点会产生较大波动，这反映了多因素模型的复杂性。

###  问题四模型的建立与求解

针对女胎异常判定体系，团队提出了模块化方案：

1. 特征工程：
   - 原始特征：Z13, Z18, Z21, ZX, GC%, 读段数，总/有效比对比例，BMI，年龄
   - 派生特征：Z绝对值、Z方差、(Z21−Z13)等对比特征，质量归一化指标

2. 基线统计判定：
   - 多元稳健协方差估计(MCD) → Mahalanobis距离阈值（χ²分布）
   - 单变量控制图（|Z|>阈值）与多变量Hotelling T²结合

3. 监督/半监督模型：
   - 无监督：Isolation Forest / One-Class SVM / LOF
   - 半监督：标签极少时使用PU-learning或校准后的异常概率

4. 融合策略：加权投票 / Logistic Stack → 输出[0,1]风险分值+置信区间

5. 结果解释：SHAP / Permutation Importance输出top贡献特征

6. 性能评估：若有金标准标签→AUC, Sens@FPR, PR-AUC；若无→稳健性评估

## 测量误差敏感性

若观测到的Y浓度含有测量误差：
$$
Y^{obs}_{ij}=Y_{ij}+\eta_{ij} \\
\eta_{ij}\sim N(0,\sigma_m^2)
$$

阈值方程近似线性解：
$$
t^*_i \approx t^{*(0)}_i + \frac{\eta}{\beta_1 + b_{1i}}
$$

斜率小则会放大误差，需向后"保守延后"推荐时点以降低假阴风险。


